from flask import Flask, request
import os, sys
import yaml
from mako.template import Template

def hook(evt, arg):
    if evt in ["sys._getframe", "object.__getattr__", "object.__setattr__"]:
        return
    frame = sys._getframe(0)
    f = frame.f_code.co_filename
    
    while frame:
        if frame.f_back is None:
            break
        else:
            frame = frame.f_back
        
        try:
            class_name = frame.f_locals['self'].__class__.__name__
        except KeyError:
            class_name = None
        
        func_name = frame.f_code.co_name
        if frame.f_code.co_filename == f:

            if class_name == None:
                if func_name == "pwnme":
                    if evt not in ['open', 'compile', 'builtins.id', 'exec']:
                        raise RuntimeError('Event not allowed')
sys.addaudithook(hook)

app = Flask(__name__)
app.secret_key = os.urandom(16)

@app.route('/', methods=["POST"])
def pwnme():
    file_content = request.files['file'].read()
    # if input_validation(file_content):
    #     return "Nice try!\n", 400
    print('Loading yaml file...')
    yaml.load(file_content)
    # print(f'File content: {file_content}')
    t = Template("yaml file loaded successfully!")
    return t.render()

if __name__ == '__main__':
    app.run(debug=True,host='0.0.0.0', port=5000)