from flask import Flask, request
import os, sys
from mako.template import Template
import pyarrow as pa 

def hook(evt, arg):
    if evt in ["sys._getframe", "object.__getattr__", "object.__setattr__"]:
        return
    frame = sys._getframe(0)
    f = frame.f_code.co_filename
    
    while frame:
        if frame.f_back is None:
            break
        else:
            frame = frame.f_back
        
        try:
            class_name = frame.f_locals['self'].__class__.__name__
        except KeyError:
            class_name = None
        
        func_name = frame.f_code.co_name
        if frame.f_code.co_filename == f:

            if class_name == None:
                if func_name == "index":
                    if evt not in ['compile', 'open', 'builtins.id', 'exec']:
                        raise RuntimeError('Event not allowed')

sys.addaudithook(hook)

app = Flask(__name__)
@app.route('/')
def index():
    with open("evil.pkl","rb") as d: 
        # print(pickle.load(d))
        pa.PyExtensionType.__arrow_ext_deserialize__(None,d.read())
    t = Template("HEELO!")
    return t.render()

if __name__ == '__main__':
    app.run(debug=True,host='0.0.0.0', port=5000)